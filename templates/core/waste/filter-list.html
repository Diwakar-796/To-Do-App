{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg p-3" style="width:100%; max-width: 800px;">
        <div class="card-body">
            <div>
                <h3 class="text-center mb-4 text-light">To-Do List</h3>
                {% comment %} <div class="dropdown">
                     <button class="btn btn-secondary bg-transparent border-0 fs-5 mb-3" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <span>&#8942;</span> <!-- or &#x22EE; -->
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">

                        {% if user.is_authenticated %}
                        <li><a class="dropdown-item" href="{% url 'profile' %}">
                                <i class="bi bi-person-fill"></i>
                                &nbsp;Profile
                            </a>
                        </li>
                        {% else %}
                        <li><a class="dropdown-item" href="{% url 'sign-in' %}">
                                <i class="bi bi-box-arrow-in-right"></i>
                                &nbsp;Sign-in
                            </a>
                        </li>
                        {% endif %}

                        <li><a class="dropdown-item" href="#">
                                <i class="bi bi-info-circle"></i>
                                &nbsp;About
                            </a>
                        </li>
                        <li><a class="dropdown-item" href="#">
                            <i class="bi bi-telephone-fill"></i>
                            &nbsp;Contact Us</a>
                        </li>
                        
                    </ul>
                </div>
                {% if user.is_authenticated %}
                <a href="{% url 'profile' %}" class="bg-transparent border-0 mb-3">
                    <i class="bi bi-person-circle fs-5 mb-5"></i>
                </a>
                {% else %}
                <a href="{% url 'sign-in' %}" class="text-light text-decoration-none mb-3">
                    <i class="bi bi-box-arrow-in-right fs-5"></i>
                </a>
                {% endif %} {% endcomment %}
            </div>

            <!-- Divider -->
            <hr class="my-4 border-light">

            <!-- Progress Section -->
            <div class="progress-box">
                <h6 class="text-center mb-4 text-light">Keep it up!</h6>
                <div class="progress">
                    <div class="progress-bar" style="width: {% widthratio task_done.count tasks.count 100 %}%;"></div>
                </div>
                <div class="progress-count">
                    <span>{{task_done.count}} / {{tasks.count}}</span>
                </div>
            </div>

            <!-- Add Task Input -->
            <form method="POST" action="{% url 'add-task' %}" class="input-group mb-3">
                {% csrf_token %}
                <input type="text" name="add-task" class="form-control rounded-start" placeholder="Add a new task...">
                <button class="btn btn-primary" type="submit" id="add-task-btn">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </form>

            <!-- Filter & Category Section -->
            <div class="mt-3" id="filterCategoryWrapper">
                <!-- Trigger Buttons -->
                <div class="d-flex justify-content-between">
                    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel" aria-expanded="false" aria-controls="filterPanel">
                        Filter Tasks
                    </button>
                    <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#categoryPanel" aria-expanded="false" aria-controls="categoryPanel">
                        Add Category
                    </button>
                </div>

                <!-- Filter Panel (collapsed by default) -->
                <div class="collapse mt-3" id="filterPanel" data-bs-parent="#filterCategoryWrapper">
                    <div class="card card-body bg-dark text-light">
                        <form method="POST" id="filterForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="filterOption" class="form-label">Filter by Category</label>
                                <select class="form-select" id="filterOption" name="category">
                                    <option value="All">All Tasks</option>
                                    {% for category in categories %}
                                        <option data-category-id="{{category.id}}" value="{{category.id}}">{{category.title}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Apply Filter</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Category Panel (collapsed by default) -->
                <div class="collapse mt-3" id="categoryPanel" data-bs-parent="#filterCategoryWrapper">
                    <div class="card card-body bg-dark text-light">
                        <form method="POST" action="{% url 'add-category' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <input type="text" name="add-category" class="form-control bg-dark text-light border-light" placeholder="Add a new category...">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-success">Add Category</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Task list -->
            <ul class="list-group list-group-flush overflow-auto filter-list" style="max-height: 300px;" id="todo-list">

                {% for task in tasks %}
                <li class="list-group-item bg-transparent text-light d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center flex-grow-1">

                        <!-- Done/Undone -->
                        <form action="{% url 'done-task' %}" method="POST" class="me-2">
                            {% csrf_token %}
                            <button type="submit" name="check" value="{{task.id}}" class="btn bg-transparent rounded-circle">
                                {% if task.is_done %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i>
                                {% endif %}
                            </button>
                        </form>

                        <!-- Task Label + Hidden Edit Input -->
                        {% if task.is_done %}
                            <span class="task-label text-decoration-line-through flex-grow-1">{{task.title}}</span>
                        {% else %}
                            <span class="task-label flex-grow-1">{{task.title}}</span>
                        {% endif %}
                        <input type="text" class="form-control edit-input d-none flex-grow-1" value="{{task.title}}">
                        
                        <!-- Hidden form for Django submission -->
                        <form action="{% url 'edit-task' %}" method="POST" class="edit-form d-none">
                            {% csrf_token %}
                            <input type="hidden" name="task_id" value="{{task.id}}">
                            <input type="hidden" name="new-title">
                        </form>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary edit-btn rounded" style="width: 42px; margin-right: 5px; margin-left: 5px;">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success save-btn d-none rounded" style="width: 42px; margin-right: 5px; margin-left: 5px;">
                            <i class="bi bi-check"></i>
                        </button>

                        <form method="POST" action="{% url 'del-task' %}">
                            {% csrf_token %}
                            <button type="submit" name="del-task" value="{{task.id}}" class="btn btn-outline-danger delete-btn rounded">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </li>
                {% endfor %}
                
            </ul>
        </div>
    </div>
</div>

<!-- Inline JS for toggling edit/save -->
<script>
document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const li = this.closest("li");
    li.querySelector(".task-label").classList.add("d-none");
    li.querySelector(".edit-input").classList.remove("d-none");
    li.querySelector(".save-btn").classList.remove("d-none");
    this.classList.add("d-none");
  });
});

document.querySelectorAll(".save-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const li = this.closest("li");
    const label = li.querySelector(".task-label");
    const input = li.querySelector(".edit-input");
    const editButton = li.querySelector(".edit-btn");
    const saveButton = li.querySelector(".save-btn");
    const form = li.querySelector(".edit-form");

    // Update text
    label.textContent = input.value.trim();

    // Toggle back
    input.classList.add("d-none");
    label.classList.remove("d-none");
    saveButton.classList.add("d-none");
    editButton.classList.remove("d-none");

    // Submit hidden form to Django
    form.querySelector("input[name='new-title']").value = input.value.trim();
    form.submit();
  });
});
</script>
{% endblock %}
